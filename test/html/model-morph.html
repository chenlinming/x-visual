<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>XTest-Morph</title>
    <script type='text/javascript' src='../../node_modules/three/build/three.min.js'></script>
    <script type='text/javascript' src='../../dist/xv-0.1.0.min.js'></script>
</head>
<body>
  <canvas id='canv'></canvas>
  <script>
    "use strict";

    /**Senario: suppose you have 2 models to be morphed (animated). */
    // initiating xworld
    const xworld = new xv.XWorld(document.getElementById('canv'),
                        window, {canvasize: [480, 320]});
    const ecs = xworld.xecs;

    const ent1 = {
        id: 'entity1',
        Obj3: { geom: xv.XComponent.Obj3Type.BOX,
                box: [200, 120, 80],    // bounding box
                // mesh is inited by thrender, can be ignored here - MorphSwitch's target
                mesh: undefined,
                 uniforms: {opacity: 0.1}},
        Visual:{vtype: xv.AssetType.mesh,
                asset: 'tex/byr0.png' },
        ModelSeqs: {
            script: [[{ mtype: xv.XComponent.AnimType.ALPHA,
                        paras: {start: 0,            // auto start
                                duration: 0.7,        // seconds
                                alpha: [0.95, 0.05],// from, to
                                 ease: xv.XEasing.Elastic.Elastic},
                        startWith:[{entity: 'points',
                                    seqx: 0,        // index of the fade-in
                                    start: 0.0}]
                     }],
                     [{ mtype: xv.XComponent.AnimType.ALPHA,
                        paras: {start: Infinity,
                                alpha: [0.05, 0.95],
                                ease: undefined},
                     }]
                 ] },
        CmpTweens: {
            // TODO docs: here are some twenn seq already defined by user.
            // Any newly animized tween sequences will be appended to it.
            // twindx is 1D array, tweens is a 2D array.
            // example: xv.ecs.sys.tween.MorphingAnim.initTweens()
            twindx: [],    // e.g. twindex[0] is 0, script[0] current is 0, created by animizer
            tweens: []}    // initialized by animizer, handled by XTweener. [] is safely ignored
    };
    xworld.addEntities(ent1);

    const ent2 = {
        id: 'entity2',
        Obj3: { geom: xv.XComponent.Obj3Type.BOX,
                box: [260, 40, 200],    // bounding box
                mesh: undefined,
                 uniforms: {opacity: 0.2}},
        Visual:{vtype: xv.AssetType.mesh,
                asset: 'city/textures/World_ap_baseColor.jpeg' },
        ModelSeqs: {
            script: [[{ mtype: xv.XComponent.AnimType.ALPHA,
                        paras: {start: Infinity,        // follow points[0][1]
                                duration: 1.2,            // seconds
                                alpha: [0.95, 0.05],    // from, to
                                 ease: xv.XEasing.Elastic.In},
                     }],
                     [{ mtype: xv.XComponent.AnimType.ALPHA,
                        paras: {start: Infinity,
                                duration: 3.2,            // seconds
                                alpha: [0.05, 0.95],
                                ease: undefined }}]
                    ]},
        CmpTweens: {
            twindx: [],    // e.g. twindex[0] is 0, script[0] current is 0, created by animizer
            tweens: []}    // initialized by animizer, handled by XTweener. [] is safely ignored
    };
    xworld.addEntities(ent2);

    const points = {
        id: 'points',
        Obj3: { geom: xv.XComponent.Obj3Type.NA,// use the geometry of entity1
                box: [200, 2, 1],
                mesh: undefined,                // THREE.Points
                 invisible: false },            // It's visible, but alpha 0?
        Visual:{vtype: xv.AssetType.refPoint,
                asset: 'entity1',
                shader: xv.XComponent.ShaderFlag.randomParticles | xv.XComponent.ShaderFlag.defaultex,
                paras: {vert_scale: '60.0',
                        a_dest: 'entity2',      // entity2.Obj3.mesh
                        // u_tex: 'tex/spark1.png',
                        u_tex: 'tex/crosstar.png',
                        a_noise: false}},
        ModelSeqs: {
            script: [[{ mtype: xv.XComponent.AnimType.ALPHA,
                        paras: {start: Infinity,    // triggered by entity1
                                duration: 1.2,      // seconds
                                alpha: [0.06, 0.92],// from, to
                                ease: xv.XEasing.Elastic.In} },
                      { mtype: xv.XComponent.AnimType.U_VERTS_TRANS,
                         paras: {start: Infinity,   // follow previous
                                duration: 1.2,      // seconds
                                uniforms: { u_morph: [0, 1],
                                            u_alpha: [0.1, 0.9] }},
                        followBy: [{entity: 'entity2',
                                    seqx: 1,        // index of the fade-in
                                    start: 0.3}] },
                      { mtype: xv.XComponent.AnimType.ALPHA,
                        paras: {start: Infinity,    // triggered by entity1
                                duration: 1.2,      // seconds
                                alpha: [0.9, 0.41], // from, to
                                ease: xv.XEasing.Elastic.In} }
                    ]] },
        CmpTweens: {}
    };
    xworld.addEntities(points);

    xworld.startUpdate();
  </script>
</body>
</html>
