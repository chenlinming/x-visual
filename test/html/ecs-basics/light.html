<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>XTest-Inputs</title>
	<script type='text/javascript' src='../../../node_modules/three/build/three.min.js'></script>
	<script type='text/javascript' src='../../../dist/xv-0.3.0.min.js'></script>
</head>
<body>
  <canvas id='canv'></canvas>
  <p>Intensity (float): <input id='intense' value='2'/><br>
	 Diffuse Color (css style): <input id='diffuse' value='0xff0'/><br>
	 Ambient Color (css style): <input id='ambient' value='0x00c'/><br>
	 Specular Color(css style): <input id='specular' value='0x0f0'/><br>
	 <input type='button' onclick='updateLight()' value='update'/>
  <script>
	"use strict";

	var log = true;
	class Lightsys extends xv.XSys {
		constructor(ecs, options) {
			super(ecs);
			this.ecs = ecs;
			this.light = options.light ? options.light : {};
			this.paras = {dirt: false};
		}

		update(tick, entities) {
			this.light.needsUpdate = false;

		 	if (this.paras.dirty) {
				this.paras.dirty = false;
				this.light.intensity = this.paras.intensity;
				this.light.ambient = this.paras.ambient;
				this.light.diffuse = this.paras.diffuse;
				this.light.specular = this.paras.specular;
				this.light.needsUpdate = true;
			}
		}

		set(p) {
			if (p) {
				var hemisphere = this.light.hemisphere
								|| {}; // prevent error before light inited
				if (p.ambient) {
					this.paras.ambient = toArr(p.ambient);
					hemisphere.groundColor = p.ambient;
				}
				if (p.diffuse) {
					this.paras.diffuse = toArr(p.diffuse);
					hemisphere.color = p.diffuse;
				}
				if (p.specular) {
					this.paras.specular = toArr(p.specular);
					hemisphere.specular = p.specular;
				}
				if (typeof p.postion === 'array') {
					this.paras.pos = p.pos;
					hemisphere.position = p.pos;
				}

				if (typeof p.intensity === 'number') {
					this.paras.intensity = p.intensity;
					hemisphere.intensity = p.intensity;
				}
				this.paras.dirty = true;
			}

			function toArr(css) {
				var hex = Math.floor( eval(css) );
				return [( hex >> 16 & 255 ) / 255,
						( hex >> 8 & 255 ) / 255,
						( hex & 255 ) / 255 ];
			}
		}

	}

	// Lightsys.query = { any: ['Light'] };
	
	const position = [500, 300, 500];
	const xworld = new xv.XWorld(document.getElementById('canv'), window,
		{light: {
			position,
			skyColor: 0xff0000,
			intensity: 4}});
	const ecs = xworld.xecs;
	const lightsys = new Lightsys(ecs, {});

	xworld.addEntities([
	  { id: 'box',
		Obj3: { geom: xv.XComponent.Obj3Type.BOX,
				box: [200, 200, 200],
				mesh: undefined },
		Visual:{vtype: xv.AssetType.mesh,
				asset: 'data:application/x-visual+img,gray-pixel'}
	  },
	  { id: 'light',
		Obj3: { geom: xv.XComponent.Obj3Type.Octahedron,
				box: [40, 0],
				transform: [{ translate: position }],
				mesh: undefined },
		Visual:{vtype: xv.AssetType.wireframe }
	  }]);

	xworld.addSystem('test', lightsys);
	xworld.startUpdate();

	function updateLight() {
		lightsys.set({
			intensity: document.getElementById('intense').value,
			ambient: document.getElementById('ambient').value,
			diffuse: document.getElementById('diffuse').value,
			specular: document.getElementById('specular').value
		});
	}

  </script>
</body>
</html>
