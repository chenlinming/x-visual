<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>XTest-Morph Color</title>
    <script type='text/javascript' src='../../node_modules/three/build/three.min.js'></script>
    <script type='text/javascript' src='../../dist/xv-0.3.0.min.js'></script>
</head>
<body>
  <canvas id='canv'></canvas>
  <script>
    "use strict";

    /**Senario: suppose you have a model changing colors. */
	class ColorMorphing extends xv.XSys {
		constructor(ecs, options) {
			super(ecs);
			this.ecs = ecs;
			this.seqx = 1;
    		ecs.createEntity( this.initCube(ecs) );
		}

		update(tick, entities) {
		 	if (xworld.xview.flag > 0) {
				this.cmd = xworld.xview.cmds[0].cmd;
			}
			else this.cmd = undefined;

			if (this.cmd === 'fire') {
				this.seqx++;
				this.seqx %= 3;
			}
			else return;

	    	for (const e of entities) {
				e.CmpTweens.startCmds.push(this.seqx);
			}
		}

		initCube(ecs) {
		    // a box can changing colors
		    const ent1 = {
		        id: 'color1',
		        Obj3: { geom:   xv.XComponent.Obj3Type.BOX,
		                box:   [200, 120, 80],
		                // mesh is inited by thrender, can be ignored here - MorphSwitch's target
		                mesh:   undefined,
		                uniforms: {opacity: 1.0}},
		        Visual:{vtype:  xv.AssetType.mesh,
		                shader: xv.XComponent.ShaderFlag.colorArray,
		                paras:{
		                    // colors' morphing weight variable name: u_morph0, u_morph1, ...
		                    colors: [
		                        [1, 0, 0],
		                        [0, 0, 1],
		                        [0, 1, 0]
		                    ] } },
		        ModelSeqs: {script:
		            [ [{mtype:  xv.XComponent.AnimType.U_MORPHi,
		                paras: {start: 0,            // auto start
		                        duration: 3.71,      // seconds
		                        uniforms: {
		                            u_morph0: [0.05, 0.95],
		                            u_morph1: [0, 0],
		                            u_morph2: [0, 0]
		                        },
		                        ease: xv.XEasing.Elastic.Elastic} }],
		              [{mtype:  xv.XComponent.AnimType.U_MORPHi,
		                paras: {start: Infinity,
		                        duration: 3.22,
		                        uniforms: {
		                            u_morph0: [0, 0],
		                            u_morph1: [0.05, 0.95],
		                            u_morph2: [0, 0]
		                        },
		                        ease: undefined} }],
		              [{mtype:  xv.XComponent.AnimType.U_MORPHi,
		                paras: {start: Infinity,
		                        duration: 4.23,
		                        uniforms: {
		                            u_morph0: [0, 0],
		                            u_morph1: [0, 0],
		                            u_morph2: [0.95, 0.05] },
		                        ease: undefined} }] ] },
		        CmpTweens: {}
		    };
			return ent1;
		}
	}

	ColorMorphing.query = { iffall: ['Obj3'] };

    // initiating xworld
    const xworld = new xv.XWorld(document.getElementById('canv'),
                        window, {canvasize: [480, 320]});
    const ecs = xworld.xecs;

	xworld.addSystem('test', new ColorMorphing(ecs, {}));
    xworld.startUpdate();
  </script>
</body>
</html>
