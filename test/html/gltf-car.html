<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>XTest-GLTF xloader</title>
	<script type='text/javascript' src='../../node_modules/three/build/three.min.js'></script>
	<script type='text/javascript' src='../../dist/xv-0.3.0.min.js'></script>
</head>
<body>
  <canvas id='canv'></canvas>
  <script>
	"use strict";

	var log = true;
	class Citysys extends xv.XSys {
		constructor(ecs, options) {
			super(ecs);
			this.ecs = ecs;
			this.initCity(ecs, options.xscene);
		}

		update(tick, entities) {
			if (log) {
				log = false;
				console.log('city-sys');
			}

	    	for (const e of entities) {
				if (e.CmdFlag) {
				 	if (e.CmdFlag.flag > 0) {
						// console.log(e.UserCmd);
						this.cmd = e.UserCmd.cmds[0].cmd;
					}
					else this.cmd = undefined;
				}
				else if (e.Visual) {
					if (this.cmd)
						console.log('visual changing: ', this.cmd);
				}
			}
		}

		initCity(ecs, scene) {
			if (ecs) {
				// var city = ecs.createEntity({
				// 	id: 'city',
				// 	Obj3: { geom: xv.XComponent.Obj3Type.USER,	// not used
				// 			box: [0, 0, 0],
				// 			transform: [
				// 				{scale: [0.1, .1, .1]},
				// 				{translate: [0, 10, 0]},
				// 			],
				// 			mesh: undefined },		// Thrender will handle this
				// 	Visual: {vtype: xv.AssetType.gltf,
				// 			 asset: 'city/scene.gltf'}// see docs/design-memo/renderer/
				// });
				var car1_3 = ecs.createEntity({
					id: 'car1_3',
					Obj3: { geom: xv.XComponent.Obj3Type.USER,	// not used
							box: [0, 0, 0],						// not used
							transform: [
								{ scale: [0.1, .1, .1] },
								{ translate: [0, 10, 0] } ],
							mesh: undefined },					// Thrender will handle this
					Visual:{vtype: xv.AssetType.gltf,
							paras: {nodes: ['CAR_03', 'ROAD', 'Light_3', 'Car_04'],
									color: undefined,			// random
						 			size: 2},					// WEBGL POINT size
							asset: 'city/scene.gltf'},
					ModelSeqs: { script: [ [
						  { mtype: xv.XComponent.AnimType.POSITION,
							paras: { start: 0,
							translate: [[0, 0, 0], [100, 0, 0]],
							ease: undefined} }] ] },
				});
			}
		}
	}

	Citysys.query = { any: ['Visual', 'Obj3'] };

	const xworld = new xv.XWorld(document.getElementById('canv'), window, {});
	const ecs = xworld.xecs;
	const xscene = xworld.xscene;

	xworld.addSystem('test', new Citysys(ecs, {xscene}));

	xworld.startUpdate();

  </script>
</body>
</html>
