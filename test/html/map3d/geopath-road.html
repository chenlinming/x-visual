<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>XTest SVG -&gt; Obj3</title>
	<script type='text/javascript' src='../../../node_modules/three/build/three.min.js'></script>
	<script type='text/javascript' src='../../../dist/xv-0.3.0.min.js'></script>
</head>
<body>
  <canvas id='canv'></canvas>
  <script>
	"use strict";

    var json0 = {
	    "type": "FeatureCollection",
	    "features": [
	        { "type": "Feature", "properties": { "name": "3 waypoints", "highway": "motorway", "oneway": "yes" },
	            "geometry": {
	                "type": "LineString",
	                "coordinates": [ [0,0], [20,0], [30,0] ]
	            }
	        }
	    ]
	};
	var origin0 = [0, -30];

    var json = {
	    "type": "FeatureCollection",
	    "features": [
	        { "type": "Feature", "properties": { "name": "cross df", "highway": "motorway", "oneway": "yes" },
	            "geometry": {
	                "type": "LineString",
	                "coordinates": [[11582404.84,3604991.03],[11582541.34,3605015.53],[11582615.46,3605028.85]]
	            }
	        },
	        { "type": "Feature", "properties": { "name": "cross df", "highway": "motorway", "oneway": "yes" },
	            "geometry": {
	                "type": "LineString",
	                "coordinates": [[11582610.8,3605054.72],[11582510.7,3605038.04],[11582397.7,3605018.89]]
	            }
	        }
	    ]
	};
	var origin = [11582404.84, 3604991.03];

	const xworld = new xv.XWorld(document.getElementById('canv'),
					  window, {canvasize: [480, 320]});

	var path0 = geopath(json0, origin0);
	var path1 = geopath(json, origin);

	function geopath(json, origin) {
		// FIXME no stream ?
		var paths = [];
		// https://github.com/uhop/stream-json/wiki/Filter
		for (var feature of json.features) {
			var property = {way: feature.properties.highway};
			var points = [];
			for (var coord of feature.geometry.coordinates) {
				points.push([coord[0] - origin[0], coord[1] - origin[1]]);
			}
			paths.push({property, points});
		}
		return paths;
	}

	// xworld.addEntities( {
	// 	id: 'way1',
	// 	Obj3: { geom: xv.XComponent.Obj3Type.MapXZRoad,
	// 			box: [0] },    // y0 = 0
	// 	Visual:{
	// 		vtype: xv.AssetType.mesh,
	// 		// shader: xv.ShaderFlag.colorArray,
	// 		paras: {
	// 			feature,
	// 			points,
	// 			origin,
	// 			colors: [[0, 0xff, 0]] } }
	// 		});
	xworld.addEntities( {
		id: 'way0',
		Obj3: { geom: xv.XComponent.Obj3Type.MapXZRoad,
				box: [0] },    // y0 = 0
		Visual:{
			vtype: xv.AssetType.mesh,
			// shader: xv.ShaderFlag.colorArray,
			paras: {
				feature: path1.property,
				points: path0[0].points,
				origin: origin0,
				colors: [[0, 0xff, 0]] } }
			});

	xworld.addEntities( {
		id: 'plane',
		Obj3: { geom: xv.XComponent.Obj3Type.PLANE,
				box: [500, 200] },    // y0 = 0
		Visual:{
			vtype: xv.AssetType.mesh,
			// shader: xv.ShaderFlag.colorArray,
			paras: {
				colors: [[0, 0xff, 0]] } }
			});
	xworld.startUpdate();
  </script>
</body>
</html>
