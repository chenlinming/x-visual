<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>XTest - Virtual Buildings</title>
	<script type='text/javascript' src='../../../node_modules/three/build/three.min.js'></script>
	<script type='text/javascript' src='../../../dist/xv-0.3.0.min.js'></script>
	<style>p {color: red}</style>
</head>
<body>
  <canvas id='canv'></canvas>
  <script>
	// "use strict";
	// const iffall = {iffall: ['BoundCubes']};
	// class VirtualArea extends xv.XSys {
	// 	constructor(ecs, options) {
	// 		super(ecs);
	// 		this.ecs = ecs;
	//
	// 		var ents = ecs.queryEntities(iffall);
	// 		this.init(ents);
	// 	}
	//
	// 	init(entities) {
	// 		for (var e of entities) {
	// 			if (!e.Visual.paras.features)
	// 				e.Visual.paras.features = [];
	//
	// 			if (e.VirtualCubes.area) {
	// 				// TODO
	// 			}
	// 			else if (e.VirtualCubes.uri) {
	// 				if (e.Visual) {
	// 					if (!e.Visual.paras)
	// 						e.Visual.paras = {};
	// 					e.Visual.paras.uri = e.VirtualCubes.uri;
	// 					e.Visual.paras.onFeature =
	// 						( ctx, f, featOpt ) => {
	// 							if (f.properties.area === 'virtual') {
	// 								// create area virtual boxes
	// 								// FIXME area has multiple polygon?
	// 								var {xzwh, loc} = xv.xgeom.xzBox(f.geometry.coordinates[0]);
	//
	// 								var boxes = createBoxes(featOpt,
	// 											f.geometry.coordinates, featOpt.boxes );
	// 								for (var box of boxes) {
	// 									// var opts = xv.Thrender.formatPrismOption(featOpt);
	// 									var opts = featOpt;
	// 									opts.geoCentre = [ loc[0] + featOpt.origin[0],
	// 													   loc[1] + featOpt.origin[1] ];
	// 									opts.height = f.properties.boxHeight !== undefined ?
	// 										f.properties.boxHeight :
	// 										featOpt.geostyle ? featOpt.geostyle.height || 1 : 1;
	// 									xv.AssetKeepr.feature2Prism(ctx, box, opts);
	// 								}
	// 							}
	// 						}
	// 				}
	// 			}
	// 		}
	//
	// 		function createBoxes (target, srcArea, config) {
	// 			var fs = target.features;
	// 			// var mxheight = target.maxHeight || 100;
	//
	// 			for (var points of srcArea) {
	// 				var {xzwh, loc} = xv.xgeom.xzBox(points);
	// 				for (var [x, z, w, d, h] of config) {
	// 					x = xzwh.x + xzwh.w * x;
	// 					z = xzwh.z + xzwh.h * z;
	// 					w = xzwh.w * Math.abs(w);
	// 					d = xzwh.h * Math.abs(d);
	// 					h = Math.abs(h);
	//
	// 					fs.push( {
	// 						properties: { height: h },
	// 						geometry: { coordinates: [[[x, z], [x+w, z], [x+w, z+d], [x, z+d]]] } } );
	// 				}
	// 			}
	// 			return fs;
	// 		}
	// 	}
	//
	// 	update(tick, entities) {
	// 	}
	// }
	//
	// VirtualArea.query = iffall;
  </script>
  <script>
	"use strict";

	const json = 'https://raw.githubusercontent.com/odys-z/x-visual/master/test/html/data/area-0.json';
	// var o3857 = [11585163, 3578479];
	const o3857 = [0, 0];
	// var west2k= [11583163, 3578479];
	const west2k= [-2000, 0];

	// box(x, z, w, d, h) of area(x, z, w, d, Visual.paras.maxHeight)
	// var box1 = [[0.8, 0.2, 0.1, 0.1, 0.71], [0.2, 0.2, 0.4, 0.6, 0.04]];
	const box1 = [[0, 0, 1, 1, 1]];
	// var box2 = [[0.1, 0.1, 0.3, 0.5, 0.4], [0.1, 0.1, 0.8, 0.75, 0.06]];
	const box2 = [[0.2, 0.2, 0.2, 0.2, 0.2]];
	const scale = 1;

	const xworld = new xv.XWorld(document.getElementById('canv'), window, {
						camera: {far: 20000},
						canvasize: [600, 300]});
	xworld.xecs.registerComponent('CBoundCubes', xv.map3.CBoundCubes );

	xworld.addEntities([
	  { id: 'va',
		Obj3: { geom: xv.XComponent.Obj3Type.GeoPrism,
				box: [] },
		Visual:{
			vtype: xv.AssetType.mesh,
			shader: xv.XComponent.ShaderFlag.boxLayers,
			paras: {
				count: 20,
				layers: 5,
				// VirtualArea
				maxHeight: 300,
				uri: undefined, // Volumetricube wil tack care of this
				origin: o3857,
				// origin: [0, 0],
				geostyle: { height: 1, scale },
			} } ,
		ModelSeqs: { script: [[{
			mtype:  xv.XComponent.AnimType.U_NOW,
			paras: {start: 0,
				speed: 0.001,   // speed para always comes with U_NOW
				duration: 0 }	// ignored
			}]]
		},
		CmpTweens: {},
		CBoundCubes: {
			uri: json,
			boxes: box1,
		}
	  },
	  { id: 'va-2',
		Obj3: { geom: xv.XComponent.Obj3Type.GeoPrism,
				box: [] },
		Visual:{
			vtype: xv.AssetType.mesh,
			shader: xv.XComponent.ShaderFlag.boxLayers,
			paras: {
				count: 20,
				layers: 5,
				// VirtualArea
				origin: west2k,
				geostyle: { height: 1, scale },
			} } ,
		CBoundCubes: {
			uri: json,
			boxes: box2,
		}
	  },
	  { id: 'calibra',
		Obj3: { geom: xv.XComponent.Obj3Type.BOX,
				box: [100, 100, 100] },
		Visual:{ vtype: xv.AssetType.wireframe }
	  }
	]);

	// must after VirtualCubes created, before xworld started
	xworld.addSystem('v-area',
		new xv.map3.BoundingCubes(xworld.xecs, {xscene: xworld.xscene}));

	xworld.startUpdate();

  </script>
</body>
</html>
