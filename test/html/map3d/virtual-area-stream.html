<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>XTest - Virtual Buildings</title>
	<script type='text/javascript' src='../../../node_modules/three/build/three.min.js'></script>
	<script type='text/javascript' src='../../../dist/xv-0.3.0.min.js'></script>
	<style>p {color: red}</style>
</head>
<body>
  <canvas id='canv'></canvas>
  <script>
	"use strict";
	const iffall = {iffall: ['VirtualCubes']};
	class VirtualArea extends xv.XSys {
		constructor(ecs, options) {
			super(ecs);
			this.ecs = ecs;

			var ents = ecs.queryEntities(iffall);
			this.init(ents);
		}

		init(entities) {
			for (var e of entities) {
				if (e.VirtualCubes.area) {
					// TODO
				}
				else if (e.VirtualCubes.uri) {
					if (e.Visual) {
						if (!e.Visual.paras)
							e.Visual.paras = {};
						e.Visual.paras.uri = e.VirtualCubes.uri;
						e.Visual.paras.onFeature =
							( ctx, f ) => {
								if (f.properties.area === 'virtual') {
									// create area virtual boxes
									if (!e.Visual.paras.features)
										e.Visual.paras.features = [];

									var boxes = createBoxes(e.Visual.paras, // xzwh, loc,
												f.geometry.coordinates, e.VirtualCubes.boxes );
									for (var box of boxes) {
										var opts = xv.Thrender.formatPrismOption(e.Visual.paras);
										xv.AssetKeepr.feature2Prism(ctx, f, opts);
									}
								}
							}
					}
				}
			}

			function createBoxes (target, srcArea, config) {
				var fs = target.features;
				var mxheight = target.maxHeight || 100;

				for (var points of srcArea) {
					var {xzwh, loc} = xv.xgeom.xzBox(points);
					for (var [x, z, w, d, h] of config) {
						x = xzwh.x + xzwh.w * x;
						z = xzwh.z + xzwh.h * z;
						w = xzwh.w * Math.abs(w);
						d = xzwh.h * Math.abs(d);
						h = mxheight * Math.abs(h);

						fs.push( {
							properties: { height: h },
							geometry: { coordinates: [[[x, z], [x+w, z], [x+w, z+d], [x, z+d]]] } } );
					}
				}
				return fs;
			}
		}

		update(tick, entities) {
		}
	}

	VirtualArea.query = iffall;
  </script>
  <script>
	"use strict";

	var json = 'https://raw.githubusercontent.com/odys-z/x-visual/master/test/html/data/area.json';
	var o3857 = [11585163, 3578479];

	// box(x, z, w, d, h) of area(x, z, w, d, Visual.paras.maxHeight)
	var box1 = [[0.8, 0.2, 0.1, 0.2, 0.8], [0.3, 0.4, 0.4, 0.2, 0.4]];
	var box2 = [[0.0, 0.1, 0.3, 0.5, 0.4], [0.7, 0.4, 0.4, 0.6, 1.2]];

	const xworld = new xv.XWorld(document.getElementById('canv'),
					  window, {canvasize: [600, 300]});
	xworld.xecs.registerComponent('VirtualCubes', {
		properties: {
			uri: '',
			area: undefined,
			boxes: undefined }
	} );

	xworld.addEntities([
	  { id: 'va',
		Obj3: { geom: xv.XComponent.Obj3Type.GeoPrism,
				box: [] },
		Visual:{
			vtype: xv.AssetType.mesh,
			shader: xv.XComponent.ShaderFlag.boxLayers,
			paras: {
				layers: 5,
				// VirtualArea
				maxHeight: 300,
				uri: undefined, // Volumetricube wil tack care of this
				origin: o3857,
				geostyle: { height: 50, scale: 0.1 },
			} } ,
		ModelSeqs: { script: [[{
			mtype:  xv.XComponent.AnimType.U_NOW,
			paras: {start: 0,
				speed: 0.001,   // speed para always comes with U_NOW
				duration: 0 }	// ignored
			}]]
		},
		CmpTweens: {},
		VirtualCubes: {
			uri: json,
			boxes: box1,
		}
	  },
	]);

	// must after VirtualCubes created, before xworld started
	xworld.addSystem('v-area',
		new VirtualArea(xworld.xecs, {xscene: xworld.xscene}));

	xworld.startUpdate();

  </script>
</body>
</html>
